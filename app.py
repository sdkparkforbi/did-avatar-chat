"""
=============================================================================
D-ID ì•„ë°”íƒ€ + OpenAI GPT ëŒ€í™” ì•±
- D-ID: ì•„ë°”íƒ€ í™”ë©´, ìŒì„±
- OpenAI: ëŒ€í™” ìƒì„±
- í™”ë©´ ê°ì²´ ì¸ì‹ ê°€ëŠ¥
=============================================================================
"""

import streamlit as st
import requests
from openai import OpenAI

# =============================================================================
# 1. ê¸°ë³¸ ì„¤ì •
# =============================================================================

st.set_page_config(page_title="ì•„ë°”íƒ€ ì±„íŒ…", page_icon="ğŸ¤–")
st.title("ğŸ¤– D-ID ì•„ë°”íƒ€ ëŒ€í™”")

# =============================================================================
# 2. API í‚¤ ê°€ì ¸ì˜¤ê¸°
# =============================================================================

# Streamlit Cloudì˜ Secretsì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
try:
    DID_KEY = st.secrets["DID_API_KEY"]
    OPENAI_KEY = st.secrets["OPENAI_API_KEY"]
except:
    st.error("âš ï¸ API í‚¤ë¥¼ ì„¤ì •í•˜ì„¸ìš” (Streamlit Cloud Secrets)")
    st.stop()

# =============================================================================
# 3. ë°ì´í„° ì €ì¥ ê³µê°„
# =============================================================================

# ì²˜ìŒ ì‹¤í–‰ì‹œ ì´ˆê¸°í™”
if 'messages' not in st.session_state:
    st.session_state.messages = []  # ëŒ€í™” ê¸°ë¡

if 'objects' not in st.session_state:
    st.session_state.objects = []  # í™”ë©´ ê°ì²´ë“¤

# =============================================================================
# 4. OpenAI GPT í•¨ìˆ˜
# =============================================================================

def ask_gpt(user_text):
    """
    ì‚¬ìš©ì ì§ˆë¬¸ â†’ GPTì—ê²Œ ë¬¼ì–´ë³´ê¸°
    í™”ë©´ ê°ì²´ ì •ë³´ë„ í•¨ê»˜ ì „ë‹¬
    """
    client = OpenAI(api_key=OPENAI_KEY)
    
    # ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë§Œë“¤ê¸°
    system_msg = "ë‹¹ì‹ ì€ ì¹œì ˆí•œ AIì…ë‹ˆë‹¤."
    
    # í™”ë©´ì— ê°ì²´ê°€ ìˆìœ¼ë©´ ì•Œë ¤ì£¼ê¸°
    if st.session_state.objects:
        objects_text = ", ".join(st.session_state.objects)
        system_msg += f"\n\nã€í™”ë©´ ì •ë³´ã€‘"
        system_msg += f"\ní˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ê°ì²´: {objects_text}"
        system_msg += f"\n\nã€ì¤‘ìš” ê·œì¹™ã€‘"
        system_msg += f"\n1. ìœ„ì¹˜ ì •ë³´(ì™¼ìª½, ì˜¤ë¥¸ìª½, ìœ„, ì•„ë˜)ëŠ” ì œê³µë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”."
        system_msg += f"\n2. ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ê°ì²´ë§Œ ì •í™•íˆ ë§í•˜ì„¸ìš”."
        system_msg += f"\n3. ì—†ëŠ” ì •ë³´ëŠ” ë§Œë“¤ì–´ë‚´ì§€ ë§ˆì„¸ìš”."
    else:
        system_msg += "\n\ní˜„ì¬ í™”ë©´ì— ê°ì²´ê°€ ì—†ìŠµë‹ˆë‹¤."
    
    # GPTì—ê²Œ ì§ˆë¬¸í•˜ê¸°
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_msg},
            {"role": "user", "content": user_text}
        ]
    )
    
    return response.choices[0].message.content

# =============================================================================
# 5. ì‚¬ì´ë“œë°” - í™”ë©´ ê°ì²´ ê´€ë¦¬
# =============================================================================

st.sidebar.header("ğŸ–¼ï¸ í™”ë©´ ê°ì²´")
st.sidebar.caption("í™”ë©´ì— ìˆëŠ” ë¬¼ê±´ì„ ì¶”ê°€í•˜ì„¸ìš”")

# ê°ì²´ ì¶”ê°€
new_object = st.sidebar.text_input("ê°ì²´ ì´ë¦„ (ì˜ˆ: ì‚¬ê³¼)")
if st.sidebar.button("â• ì¶”ê°€"):
    if new_object:
        st.session_state.objects.append(new_object)

# í˜„ì¬ ê°ì²´ ë³´ì—¬ì£¼ê¸°
if st.session_state.objects:
    for obj in st.session_state.objects:
        st.sidebar.write(f"â€¢ {obj}")
else:
    st.sidebar.info("ê°ì²´ ì—†ìŒ")

# ì „ì²´ ì‚­ì œ
if st.sidebar.button("ğŸ—‘ï¸ ëª¨ë‘ ì‚­ì œ"):
    st.session_state.objects = []
    st.rerun()

# =============================================================================
# 6. ëŒ€í™” í™”ë©´
# =============================================================================

# ì´ì „ ëŒ€í™” ë³´ì—¬ì£¼ê¸°
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])

# =============================================================================
# 7. ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
# =============================================================================

user_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...")

if user_input:
    # 1. ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ & í‘œì‹œ
    st.session_state.messages.append({
        "role": "user",
        "content": user_input
    })
    
    with st.chat_message("user"):
        st.write(user_input)
    
    # 2. GPTì—ê²Œ ë¬¼ì–´ë³´ê¸°
    with st.chat_message("assistant"):
        with st.spinner("ìƒê° ì¤‘..."):
            answer = ask_gpt(user_input)
        st.write(answer)
    
    # 3. AI ë‹µë³€ ì €ì¥
    st.session_state.messages.append({
        "role": "assistant",
        "content": answer
    })
    
    st.rerun()

# =============================================================================
# 8. ì•ˆë‚´ ë©”ì‹œì§€
# =============================================================================

st.markdown("---")
st.info("""
ğŸ’¡ **ì‚¬ìš© ë°©ë²•:**
1. ì™¼ìª½ì—ì„œ í™”ë©´ ê°ì²´ ì¶”ê°€ (ì˜ˆ: ì‚¬ê³¼, ê·¤)
2. ì•„ë˜ì—ì„œ ëŒ€í™” ì‹œì‘
3. GPTê°€ í™”ë©´ ê°ì²´ë¥¼ ì¸ì‹í•©ë‹ˆë‹¤!

ğŸ“Œ **D-ID ì•„ë°”íƒ€ ì—°ê²°ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì¶”ê°€ë©ë‹ˆë‹¤.**
""")

# =============================================================================
# ë
# =============================================================================
